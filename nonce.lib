<?php
# Copyright (C) Finkle Enterprises, LLC 2014   Used by permission only. F. Koenen fkoenen@feweb.net
class noncelib {private$duration,$uniqkey,$name;public function noncelib($args=array()){extract($args);$this->duration=(isset($duration)&&(int)$duration>=30 &&(int)$duration <=86400)?$duration:30;$this->uniqkey=(isset($uniqkey)&&trim(str_replace('"','',$uniqkey)).'x'!='x')?trim(str_replace('"','',$uniqkey)):'DoubleCubeIs643216842';$this->name=(isset($name)&&trim(str_replace('"','',$name)).'x'!='x')?trim(str_replace('"','',$name)):'noncelib';}public function getarray($action='',$user=''){return array($this->name,$this->gethash($action,$user));}public function querystring($action='',$user=''){return$this->name.'='.$this->gethash($action,$user);}public function formfield($action='',$user=''){return '<input type="hidden" id="'.$this->name.'_nonce" name="'.$this->name.'_nonce" value="'.$this->gethash($action,$user).'" />';}public function nonce($action='',$user=''){return$this->gethash($action,$user);}public function isvalid($nonce,$action='',$user=''){if(substr($this->nh($action.$user),-12,10)==$nonce)return true;return false;}public function gethash($action='',$user=''){return substr($this->nh($action.$user),-12,10);}private function nh($action='',$user=''){$i=(int)$_SESSION['noncelib_'.$this->name.'_expire'];if(!$_SESSION['noncelib_'.$this->name.'_expire'])$_SESSION['noncelib_'.$this->name.'_expire']=time()+$this->duration;if(time()>(int)$_SESSION['noncelib_'.$this->name.'_expire'])$i=$_SESSION['noncelib_'.$this->name.'_expire']=time()+$this->duration;if($i <=0)$i=ceil( time()/($this->duration));return md5($i.$action.$user.$action);}}
